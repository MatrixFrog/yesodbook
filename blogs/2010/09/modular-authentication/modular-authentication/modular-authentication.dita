<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="modular-authentication"><title>Modular Authentication</title><body><foreign outputclass="html">&lt;p&gt;Dependencies are often a bit of a bind. On the one hand, I want Yesod to be as fully-featured as possible. On the other hand, adding dependencies makes it more difficult to install, especially when those dependencies are system C libraries.&lt;/p&gt;
&lt;p&gt;Case in point: Yesod currently has support for OpenID version 1. There is a &lt;a href="http://hackage.haskell.org/package/openid"&gt;package providing OpenID 2 support&lt;/a&gt; on Hackage, but it introduces a dependency on OpenSSL, which could be difficult for some users to install. (Side point: I can't actually get the package to work; has anyone else had any luck?)&lt;/p&gt;
&lt;p&gt;The current approach to authentication hard-codes in all of the possible authentication backends. For the moment, this is OpenID 1, Rpxnow, Facebook and email address. But now I want to support OpenID 2, &lt;i&gt;without&lt;/i&gt; changing the Yesod package at all. As it is, this is not possible.&lt;/p&gt;
&lt;p&gt;So I'm experimenting with a new, modular authentication framework based upon authentication plugins. The system is very simple: a plugin consists of three pieces:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A name.&lt;/li&gt;
&lt;li&gt;A widget to display on the login screen. For Facebook, this is a "click here to login" link. For OpenID, it's a typical OpenID input field.&lt;/li&gt;
&lt;li&gt;A dispatch function for handling user requests.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There's a datatype called &lt;code&gt;Creds&lt;/code&gt;, as in credentials, and a function called setCreds provided by the new auth module. Plugins simply call setCreds when a user logs in. The application developer determines how to map credentials onto his/her database, and the auth module itself handles the logout page, a status page (useful for Ajax programs) and a login page.&lt;/p&gt;
&lt;p&gt;The downside of this new approach is a loss of some type safety: individual plugins cannot have type-safe URLs, but instead must use a &lt;code&gt;[String]&lt;/code&gt; to create links. This is definitely a downside, but I think it is a necessary evil to provide the modularity necessary here.&lt;/p&gt;
&lt;p&gt;I've created &lt;a href="http://github.com/snoyberg/yesod/tree/newauth/yesod-auth/"&gt;a new branch on github&lt;/a&gt; for this code. If you want to take a look, I'd recommend looking at &lt;a href="http://github.com/snoyberg/yesod/blob/newauth/yesod-auth/auth2.hs"&gt;the sample app&lt;/a&gt; and the &lt;a href="http://github.com/snoyberg/yesod/blob/newauth/yesod-auth/Yesod/Helpers/Auth2.hs"&gt;Yesod.Helpers.Auth2&lt;/a&gt; module.&lt;/p&gt;
&lt;p&gt;One question: I'm considering separating the entire authentication system into its own package so that its API can change without affecting Yesod version numbers. Any thoughts on that approach? Obviously plugins will be released as their own packages under this new scheme.&lt;/p&gt;
</foreign></body></topic>