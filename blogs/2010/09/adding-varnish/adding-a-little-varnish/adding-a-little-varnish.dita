<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="adding-a-little-varnish"><title>Adding a little varnish</title><body><foreign outputclass="html">&lt;p&gt;Since the &lt;a href="http://docs.yesodweb.com/blog/yesod-0-5/"&gt;latest release&lt;/a&gt; of Yesod I've been working on consolidating Yesod information onto my new VPS system. I'd previously kept this blog on &lt;a href="http://www.snoyman.com/"&gt;my personal domain name&lt;/a&gt; and the &lt;a href="http://docs.yesodweb.com/"&gt;docs site separate&lt;/a&gt;, and generated both of them as static sites (the former via a custom script, the latter via Hakyll).&lt;/p&gt;
&lt;p&gt;However, I decided to combine both sites into a single Yesod site; you are reading the result. In the process, I've put the majority of the old documentation into &lt;a href="http://docs.yesodweb.com/book/"&gt;the book&lt;/a&gt; and created separate &lt;a href="http://docs.yesodweb.com/examples/"&gt;examples&lt;/a&gt; and &lt;a href="http://docs.yesodweb.com/screencasts/"&gt;screencasts&lt;/a&gt; sections. Hopefully, this should make it much easier to find information.&lt;/p&gt;
&lt;h3&gt;Testing examples&lt;/h3&gt;
&lt;p&gt;All of the examples on the site double as executables in the &lt;a href="http://hackage.haskell.org/package/yesod-examples"&gt;yesod-examples package&lt;/a&gt; on hackage. This provides a simple means to test that the examples are written correctly and still compile with new versions of Yesod. However, up until recently, examples in the rest of the documentation and the book had no such testing involved.&lt;/p&gt;
&lt;p&gt;So I devised a very simple solution: there's a snippets folder that contains various Haskell files, each one a stand-alone executable. The book simply embeds pieces from those files for the code snippets. Also, I finally added in syntax highlighting via &lt;a href="http://hackage.haskell.org/package/hscolour"&gt;hscolour&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;Varnish&lt;/h3&gt;
&lt;p&gt;Anyway, the part that I thought people would actually be interested in: loading up all of these various static files for each request and performing all the syntax highlighting and markdown rendering is a fairly heavy performance price. At first, I'd thought about playing with caching the results in temporary files and checking file modification times.&lt;/p&gt;
&lt;p&gt;Instead, a much simpler solution presented itself: &lt;a href="http://www.varnish-cache.org/"&gt;Varnish&lt;/a&gt;, an HTTP accelerator that performs caching. I'd read about it a while ago, but never found it necessary, since most of &lt;a href="http://www.search-once.com/"&gt;my&lt;/a&gt; &lt;a href="http://luach.snoyman.com/"&gt;Yesod&lt;/a&gt; &lt;a href="http://www.orangeroster.com/"&gt;sites&lt;/a&gt; are purely dynamic sites, which are not amenable to caching.&lt;/p&gt;
&lt;p&gt;Setting up Varnish was incredibly simple: I already run my nginx server on port 8080 and have port forwarding redirect traffic from port 80. Now, Varnish simply listens on port 8081 and port forwarding redirects 80 to 8081. And I get to have that warm, fuzzy feeling of using some new technology I read about on Reddit. Yeah!&lt;/p&gt;
&lt;p&gt;The only code change required to take advantage of Varnish is an HTTP &lt;code&gt;cache-control&lt;/code&gt; response header, which is already easy enough with the &lt;code&gt;setHeader&lt;/code&gt; Yesod function. I'll probably make a minor release of Yesod (0.5.1?) to include some helper functions to make this easier.&lt;/p&gt;
&lt;h3&gt;Which reminds me...&lt;/h3&gt;
&lt;p&gt;It's a real pain getting a VPS set up. Now that I'm hosting a number of different Yesod apps from my VPS now, it's fairly easy and straightforward to add more Yesod apps to it. Each Yesod app requires a very small amount of resources (&lt; 20M of RAM and not too much CPU), but still requires a VPS with enough RAM to actually pull off the compiles itself.&lt;/p&gt;
&lt;p&gt;This makes me think Yesod apps are quite amenable to some kind of managed hosting. I've thought about this a little bit, and here's the idea I've come up with:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;We would need some kind of standard format for applications. I think a cabalized tarball is the perfect fit.&lt;/li&gt;
&lt;li&gt;Have a requirement that each cabal file have a rule to build an executable called &lt;code&gt;fastcgi&lt;/code&gt;, and build this file with the cabal flag &lt;code&gt;production&lt;/code&gt;. This is what the current scaffolder does. (A future idea would be to design a file that could use &lt;i&gt;any&lt;/i&gt; WAI backend, but I wanted to start simple.)&lt;/li&gt;
&lt;li&gt;Since Template Haskell code can be run at compile time, for security the build of the process should occur in a chroot jail.&lt;/li&gt;
&lt;li&gt;Running the application would also occur in a chroot jail. All of the source code from the tarball would be present in the chroot jail, so extra resources (settings files, etc) would be present. Static files should follow the standard layout: in the static folder.&lt;/li&gt;
&lt;li&gt;As per my &lt;a href="http://docs.yesodweb.com/book/deploying/"&gt;deploying advice&lt;/a&gt;, use spawn-fcgi and bind to a named socket, and have an nginx config block automatically generated that talks to that socket. Perhaps some information on domain name should be included in the tarball, of perhaps that would be part of a web-based admin util.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I'm kind of tempted to set up an automated system like this, if only to automate the management of my current sites. If anyone would be interested in this kind of hosting, and would like to help me test this out, &lt;a href="mailto:michael@snoyman.com"&gt;let me know&lt;/a&gt;. I still have a little bit of extra room on my VPS to play around with.&lt;/p&gt;
</foreign></body></topic>